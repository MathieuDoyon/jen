# Version of jen file format (for future compatibility checks)
version: 0.2.0

# Description displayed to user during template selection
description: The customary Hello World example

# Placeholders are a lightweight alternative to go template expressions, which can be used as
# plain text anywhere in file/dir names and template files. Because placeholders are processed
# using plain search-and-replace, ensure they have improbable names that don't risk conflicting
# with anything else (ie: "projekt").
placeholders:
  projekt: "{{.PROJECT | lower}}"
  Projekt: "{{.PROJECT | title}}"
  PROJEKT: "{{.PROJECT | upper}}"

# Actions are sets of steps that can be invoked by user by their name
actions:
  # By convention, the "create" action is in charge of scaffolding the project initially
  create:
    # This step invokes the "prompt" action defined below
    - do: prompt
    # This step renders template files under "./project" sub-dir into current dir
    - render: ./project
    # This step only executes its child steps if given expression evaluates to true
    - if: .INSTALL
      then:
        # This step invokes the "install" action defined below
        - do: install

  # By convention, the "prompt" action is in charge of prompting user for project
  # variables. It is typically invoked as the first step of "create" action above, but
  # can also be invoked manually by user at a later time to modify variables or to
  # associate a template with an existing project that was not initially generated by
  # jen.
  prompt:
    # The "input" step prompts user for a single string variable
    - input:
        question: Project name
        var: PROJECT
        # Here we use the special "projectDirName" variable to propose to the user the
        # project's directory name as default project name, which is most often the case.
        default: "{{ .projectDirName }}"

    # The "option" step prompts user for a single boolean variable as a yes/no question
    - option:
        question: Do you want to register project {{ .PROJECT }} in infrastructure?
        var: INSTALL
        default: true

    # The "options" step prompts user for multiple boolean variables as a list of toggles
    - options:
        question: Select desired features
        items:
          - text: PostgreSQL database
            var: PSQL
            default: true
          - text: NewRelic instrumentation
            var: NEWRELIC
            default: false

    # The "choice" step prompts user for a single string value from a list of choices.
    - choice:
        question: What is your team?
        var: TEAM
        default: backend
        items:
          - text: Back End
            value: backend
          - text: Front End
            value: frontend
          - text: DevOps
            value: devops
          - text: Site Reliability Engineering
            value: sre
          - text: Customer Success Engineering
            value: cse

    # The "set" step sets one or multiple variables to given values without user intervention.
    - set:
        ORGANIZATION_ID: 123456789
        CLOUD_PROJECT_ID: 987654321

  # By convention, the "install" action is in charge of setting the project up with CI/CD
  # and infra. It is typically invoked as the last step of the "create" action.
  install:
    # The "exec" step allows to invoke shell commands, including shell scripts, while
    # passing them all project variables as env vars. In this case, it specifies a list
    # of multiple commands to execute.
    - exec:
        - create-docker-repo
        - create-cicd-triggers

  # By convention, the "uninstall" action is in charge of removing the project from infra
  uninstall:
    # The "confirm" step is similar to "if", however it prompts user with given message and
    # only upon confirmation executes steps in the "then" clause.
    - confirm: Are you sure you want to completely uninstall project {{.PROJECT}} from infrastructure?
      then:
        # Here the "exec" step is invoked multiple times, each executing a single command
        - exec: remove-docker-repo
        - exec: remove-cicd-triggers

  # This action can be invoked multiple times after project has been initially scaffolded, in
  # order to simulate adding endpoints to our microservice.
  add-endpoint:
    - input:
        question: Endpoint name
        var: NAME
    - input:
        question: Endpoint path
        var: PATH
    # This renders templates under `endpoint` sub-directory. One of those template files has a `.insert`
    # extension, meaning it is a special "insertion" template, which is meant to be inserted into an
    # existing file of the same name at a specific insertion point (defined by regular expressions).
    # Have a look at that file for more details on how it works.
    - render: endpoint
